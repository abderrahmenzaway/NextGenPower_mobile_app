<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wind Turbine Control</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    header { margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; }
    section { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; }
    h2 { margin-top: 0; }
    .status { padding: 0.5rem 0.75rem; border-radius: 999px; display: inline-block; }
    .ok { background: #e8f5e9; color: #2e7d32; }
    .bad { background: #ffebee; color: #c62828; }
    .warn { background: #fff8e1; color: #ef6c00; }
    .flash { margin: 0.5rem 0; }
    .flash > div { padding: 0.5rem 0.75rem; border-radius: 6px; margin-bottom: 0.25rem; }
    .success { background: #e8f5e9; }
    .error { background: #ffebee; }
    .info { background: #e3f2fd; }
    .warning { background: #fff8e1; }
    form { display: inline; }
    input[type="number"] { padding: 0.4rem; width: 6rem; }
    button { padding: 0.5rem 0.8rem; border: 1px solid #ccc; border-radius: 6px; background: black; cursor: pointer; }
    button:hover { background: #f0f0f0; }
    pre { background: #f7f7f7; padding: 0.75rem; border-radius: 6px; overflow: auto; }
  </style>
</head>
<body>
  <header>
    <h1>Wind Turbine Control </h1>
    <p>Location: <strong>{{ config.openweather.city }}</strong> ({{ config.openweather.latitude }}, {{ config.openweather.longitude }})</p>
    <p>Arduino Port: <code>{{ config.arduino.port }}</code></p>
    <div class="status {{ 'ok' if arduino_connected else 'bad' }}">
      {{ 'Arduino Connected' if arduino_connected else 'Arduino Disconnected' }}
    </div>
  </header>

  <div class="flash">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <div class="grid">
    <section>
      <h2>Set Location</h2>
      <form method="post" action="{{ url_for('update_location') }}">
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
          <label>City</label>
          <input type="text" name="city" value="{{ config.openweather.city }}" placeholder="City name" style="padding:0.4rem; min-width:12rem;">
          <label>Latitude</label>
          <input type="number" step="any" name="latitude" value="{{ config.openweather.latitude }}" style="padding:0.4rem; width:10rem;">
          <label>Longitude</label>
          <input type="number" step="any" name="longitude" value="{{ config.openweather.longitude }}" style="padding:0.4rem; width:10rem;">
          <button type="submit">Save</button>
        </div>
      </form>
    </section>
    <section>
      <h2>Arduino Connection</h2>
      <form method="post" action="{{ url_for('connect_arduino') }}">
        <button type="submit">Connect</button>
      </form>
      <form method="post" action="{{ url_for('disconnect_arduino') }}">
        <button type="submit">Disconnect</button>
      </form>
    </section>
    <section>
      <h2>Full Update</h2>
      <p>Fetch wind direction and rotate servo accordingly.</p>
      <form method="post" action="{{ url_for('update_turbine') }}">
        <button type="submit">Run Update</button>
      </form>
    </section>
  </div>

  <script>
    async function fetchWeather() {
      const el = document.getElementById('weather');
      el.textContent = 'Loading...';
      try {
        const res = await fetch("{{ url_for('get_weather') }}");
        const data = await res.json();
        el.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        el.textContent = 'Failed to fetch weather';
      }
    }
    async function getAngle() {
      const el = document.getElementById('angle');
      el.textContent = 'Loading...';
      try {
        const res = await fetch("{{ url_for('current_angle') }}");
        const data = await res.json();
        el.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        el.textContent = 'Failed to read angle';
      }
    }
  </script>
</body>
</html>
